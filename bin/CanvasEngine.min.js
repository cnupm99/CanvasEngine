(function(){var h=function(f,g){function h(){this.constructor=f}for(var m in g)p.call(g,m)&&(f[m]=g[m]);h.prototype=g.prototype;f.prototype=new h;f.__super__=g.prototype;return f},p={}.hasOwnProperty,q=function(f,g){return function(){return f.apply(g,arguments)}};define(function(){var f=function(){function d(b){this._rotation=b.rotation||0;this._alpha=b.alpha||1;this._sizes=this._point(b.sizes);this._position=this._point(b.position);this._center=this._point(b.center)}d.prototype._point=function(b,
a){return null==b?[0,0]:null!=a?[this._int(b),this._int(a)]:Array.isArray(b)?[this._int(b[0]),this._int(b[1])]:null!=b.x&&null!=b.y?[this._int(b.x),this._int(b.y)]:null!=b.width&&null!=b.height?[this._int(b.width),this._int(b.height)]:[0,0]};d.prototype._int=function(b){return Math.round(this._value(b))};d.prototype._value=function(b){return null!=b?+b:0};return d}();var g=function(d){function b(a){b.__super__.constructor.call(this,a);this.name=a.name;this._shadow=!1;this._visible=null!=a.visible?
a.visible:!0;this._context=a.parent.context;this._parentPosition=a.parent.position;this.needAnimation=this._visible}h(b,d);b.prototype.testPoint=function(a,b){if(!this.testRect(a,b))return!1;var c=this._context.getImageData(a,b,1,1).data;null==c.every&&(c.every=Array.prototype.every);return!c.every(function(a){return 0===a})};b.prototype.testRect=function(a,b){var c=this._position[0]+this._parentPosition[0];var d=this._position[1]+this._parentPosition[1];var k=c+this._sizes[0];var l=d+this._sizes[1];
return a>=c&&a<=k&&b>=d&&b<=l};b.prototype.getPosition=function(){return this._position};b.prototype.shift=function(a,b){null==a&&(a=0);null==b&&(b=0);return this.setPosition([a+this._position[0],b+this._position[1]])};b.prototype.setVisible=function(a){return this.needAnimation=this._visible=null!=a?a:!0};b.prototype.setTransform=function(a){this.setSizes(a.sizes);this.setPosition(a.position);this.setCenter(a.center);this.setRotation(a.rotation);return this.setAlpha(a.alpha)};b.prototype.setSizes=
function(a){null!=a&&(this._sizes=this._point(a));return this.needAnimation=!0};b.prototype.setPosition=function(a){null!=a&&(this._position=this._point(a));return this.needAnimation=!0};b.prototype.setCenter=function(a){null!=a&&(this._center=this._point(a));return this.needAnimation=!0};b.prototype.setRotation=function(a){null!=a&&(this._rotation=this._value(a));return this.needAnimation=!0};b.prototype.setAlpha=function(a){null!=a&&(this._alpha=this._value(a));return this.needAnimation=!0};b.prototype.setShadow=
function(a){this._shadow=null!=a?{color:a.color||"#000",blur:a.blur||3,offsetX:a.offsetX||0,offsetY:a.offsetY||0,offset:a.offset||0}:!1;return this.needAnimation=!0};b.prototype.animate=function(a){if(this._visible)return a.save(),this._deltaX=this._position[0],this._deltaY=this._position[1],this._shadow&&(a.shadowColor=this._shadow.color,a.shadowBlur=this._shadow.blur,a.shadowOffsetX=Math.max(this._shadow.offsetX,this._shadow.offset),a.shadowOffsetY=Math.max(this._shadow.offsetY,this._shadow.offset)),
0!==this._rotation&&(a.translate(this._center[0]+this._position[0],this._center[1]+this._position[1]),a.rotate(this._rotation*Math.PI/180),this._deltaX=-this._center[0],this._deltaY=-this._center[1]),this.needAnimation=!1;this.needAnimation=!1};return b}(f);var p=function(d){function b(a){b.__super__.constructor.call(this,a);this._commands=[];this.needAnimation=!1}h(b,d);b.prototype.line=function(a,b,e,d){a=this._point(a,b);e=this._point(e,d);this._commands.push({command:"line",from:a,to:e});return this.needAnimation=
!0};b.prototype.clear=function(){this._commands=[];return this.needAnimation=!0};b.prototype.strokeStyle=function(a){return this._commands.push({command:"strokeStyle",style:a})};b.prototype.fillStyle=function(a){return this._commands.push({command:"fillStyle",style:a})};b.prototype.linearGradient=function(a,b,e,d,k){return this._commands.push({command:"gradient",point1:this._point(a,b),point2:this._point(e,d),colors:k})};b.prototype.rect=function(a,b,e,d,k){null==k&&(k=0);a=this._point(a,b);e=this._point(e,
d);this._commands.push({command:"rect",point:a,sizes:e,radius:k});return this.needAnimation=!0};b.prototype.moveTo=function(a,b){var c=this._point(a,b);return this._commands.push({command:"moveTo",point:c})};b.prototype.lineTo=function(a,b){var c=this._point(a,b);this._commands.push({command:"lineTo",point:c});return this.needAnimation=!0};b.prototype.fill=function(){this._commands.push({command:"fill"});return this.needAnimation=!0};b.prototype.stroke=function(){this._commands.push({command:"stroke"});
return this.needAnimation=!0};b.prototype.polyline=function(a,b){null==b&&(b=!0);this._commands.push({command:"beginPath"});this.moveTo(a[0][0],a[0][1]);a.forEach(function(a){return function(b){return a.lineTo(b[0],b[1])}}(this));b&&this._commands.push({command:"stroke"});return this.needAnimation=!0};b.prototype.polygon=function(a){this.polyline(a,!1);this.lineTo(a[0][0],a[0][1]);this._commands.push({command:"stroke"});this._commands.push({command:"fill"});return this.needAnimation=!0};b.prototype.lineWidth=
function(a){a=this._int(a);return this._commands.push({command:"lineWidth",width:a})};b.prototype.setLineDash=function(a){return this._commands.push({command:"setDash",dash:a})};b.prototype.lineDashOffset=function(a){a=this._int(a);return this._commands.push({command:"dashOffset",offset:a})};b.prototype._drawRoundedRect=function(a,b,e,d,k,l){var c=Math.PI;var n=c/2;var f=b+l;var g=b+d-l;var h=e+l;var m=e+k-l;a.moveTo(f,e);a.lineTo(g,e);a.arc(g,h,l,-n,0);a.lineTo(b+d,m);a.arc(g,m,l,0,n);a.lineTo(f,
e+k);a.arc(f,m,l,n,c);a.lineTo(b,h);return a.arc(f,h,l,c,3*n)};b.prototype.animate=function(a){null==a&&(a=this._context);b.__super__.animate.call(this,a);a.lineCap="round";this._commands.forEach(function(b){return function(c){switch(c.command){case "beginPath":return a.beginPath();case "stroke":return a.stroke();case "fill":return a.fill();case "setDash":return a.setLineDash(c.dash);case "dashOffset":return a.lineDashOffset=c.offset;case "moveTo":return a.moveTo(c.point[0]+b._deltaX,c.point[1]+b._deltaY);
case "lineTo":return a.lineTo(c.point[0]+b._deltaX,c.point[1]+b._deltaY);case "line":return a.beginPath(),a.moveTo(c.from[0]+b._deltaX,c.from[1]+b._deltaY),a.lineTo(c.to[0]+b._deltaX,c.to[1]+b._deltaY),a.stroke();case "strokeStyle":return a.strokeStyle=c.style;case "fillStyle":return a.fillStyle=c.style;case "lineWidth":return a.lineWidth=c.width;case "rect":return a.beginPath(),0===c.radius?a.rect(c.point[0]+b._deltaX,c.point[1]+b._deltaY,c.sizes[0],c.sizes[1]):b._drawRoundedRect(a,c.point[0]+b._deltaX,
c.point[1]+b._deltaY,c.sizes[0],c.sizes[1],c.radius);case "gradient":var e=a.createLinearGradient(c.point1[0]+b._deltaX,c.point1[1]+b._deltaY,c.point2[0]+b._deltaX,c.point2[1]+b._deltaY);c.colors.forEach(function(a){return e.addColorStop(a[0],a[1])});return a.fillStyle=e}}}(this));a.restore();return this.needAnimation=!1};return b}(g);var m=function(d){function b(a){b.__super__.constructor.call(this,a);this.setFont(a.font);this.setText(a.text||"");this.fillStyle(a.fillStyle);this._strokeStyle=a.strokeStyle||
!1;this._strokeWidth=a.strokeWidth||1;this.needAnimation=!0}h(b,d);b.prototype.setText=function(a){this._text=a;this._context.save();this._context.font=this._font;this.width=this._context.measureText(this._text).width;this._context.restore();return this.needAnimation=!0};b.prototype.fillStyle=function(a){this._fillStyle=a||!1;return this.needAnimation=!0};b.prototype.strokeStyle=function(a){this._strokeStyle=a||!1;return this.needAnimation=!0};b.prototype.setFont=function(a){this._font=a||"12px Arial";
a=document.createElement("span");a.appendChild(document.createTextNode("height"));a.style.cssText="font: "+this._font+"; white-space: nowrap; display: inline;";document.body.appendChild(a);this.fontHeight=a.offsetHeight;document.body.removeChild(a);return this.needAnimation=!0};b.prototype.animate=function(a){null==a&&(a=this._context);b.__super__.animate.call(this,a);a.font=this._font;a.textBaseline="top";if(this._fillStyle){if(Array.isArray(this._fillStyle)){var c=a.createLinearGradient(this._deltaX,
this._deltaY,this._deltaX,this._deltaY+this.fontHeight);this._fillStyle.forEach(function(a){return c.addColorStop(a[0],a[1])});a.fillStyle=c}else a.fillStyle=this._fillStyle;a.fillText(this._text,this._deltaX,this._deltaY)}this._strokeStyle&&(a.strokeStyle=this._strokeStyle,a.lineWidth=this._strokeWidth,a.strokeText(this._text,this._deltaX,this._deltaY));a.restore();return this.needAnimation=!1};return b}(g);var r=function(d){function b(a){b.__super__.constructor.call(this,a);this.onload=a.onload;
null!=a.src?(this._image=document.createElement("img"),this._loaded=this.needAnimation=!1,this.setSrc(a.src)):this.from(a.from)}h(b,d);b.prototype.setSrc=function(a){this._loaded=!1;this._image.onload=function(a){return function(){a._realSizes=[a._image.width,a._image.height];if(0>=a._sizes[0]||0>=a._sizes[1])a._sizes=a._realSizes;a.needAnimation=!0;a._loaded=!0;if(null!=a.onload)return a.onload(a._realSizes)}}(this);return this._image.src=a};b.prototype.from=function(a){this._image=a.image;this._src=
a.src;this._realSizes=a.sizes;if(0>=this._sizes[0]||0>=this._sizes[1])this._sizes=this._realSizes;return this.needAnimation=this._loaded=!0};b.prototype.getSizes=function(){return this._sizes};b.prototype.getRealSizes=function(){return this._realSizes};b.prototype.animate=function(a){null==a&&(a=this._context);if(this._loaded)return b.__super__.animate.call(this,a),this._sizes[0]===this._realSizes[0]&&this._sizes[1]===this._realSizes[1]?a.drawImage(this._image,this._deltaX,this._deltaY):a.drawImage(this._image,
this._deltaX,this._deltaY,this._sizes[0],this._sizes[1]),a.restore(),this.needAnimation=!1};return b}(g);var t=function(d){function b(a){b.__super__.constructor.call(this,a);this._rect=a.rect||[0,0,a.parent.sizes[0],a.parent.sizes[1]]}h(b,d);b.prototype.setRect=function(a){this._rect=a;return this.needAnimation=!0};b.prototype.animate=function(a){null==a&&(a=this._context);if(this._loaded)return b.__super__.animate.call(this,a),a.fillStyle=a.createPattern(this._image,"repeat"),a.rect(this._rect[0],
this._rect[1],this._rect[2],this._rect[3]),a.fill(),a.restore(),this.needAnimation=!1};return b}(r);var u=function(d){function b(a){b.__super__.constructor.call(this,a);this.name=a.name;this._parentPosition=a.parentPosition;this.canvas=document.createElement("canvas");this.canvas.style.position="absolute";this.setZ(a.zIndex);this.context=this.canvas.getContext("2d");this.setTransform(a);this._needAnimation=this._mask=!1;this.objects=[]}h(b,d);b.prototype.setZ=function(a){this._zIndex=this._int(a);
return this.canvas.style.zIndex=this._zIndex};b.prototype.getZ=function(){return this._zIndex};b.prototype.add=function(a){if(null!=a.type){a.parent={};a.parent.context=this.context;a.parent.position=[this._position[0]+this._parentPosition[0],this._position[1]+this._parentPosition[1]];a.parent.sizes=this._sizes;switch(a.type){case "image":var b=new r(a);break;case "text":b=new m(a);break;case "graph":b=new p(a);break;case "tile":b=new t(a)}this.objects.push(b);b.getScene=function(a){return function(){return a}}(this);
return b}};b.prototype.get=function(a){var b=!1;this.objects.some(function(c){var d;(d=c.name===a)&&(b=c);return d});return b};b.prototype.remove=function(a){var b=-1;this.objects.some(function(c,d){var e;(e=c.name===a)&&(b=d);return e});return-1<b?(this.objects.splice(b,1),!0):!1};b.prototype.addChild=function(a){this.objects.push(a);return this._needAnimation=!0};b.prototype.removeChild=function(a){var b=-1;this.objects.some(function(c,d){var e;(e=c===a)&&(b=d);return e});return-1<b?(this.objects.splice(b,
1),!0):!1};b.prototype.needAnimation=function(){return this._needAnimation||this.objects.some(function(a){return a.needAnimation})};b.prototype.testPoint=function(a,b){if(!this.testRect(a,b))return!1;var c=this.context.getImageData(a,b,1,1).data;null==c.every&&(c.every=Array.prototype.every);return!c.every(function(a){return 0===a})};b.prototype.testRect=function(a,b){var c=this._position[0]+this._parentPosition[0];var d=this._position[1]+this._parentPosition[1];var f=c+this._sizes[0];var g=d+this._sizes[1];
return a>=c&&a<=f&&b>=d&&b<=g};b.prototype.getSizes=function(){return this._sizes};b.prototype.setMask=function(a,b,d,f){this._mask=4>arguments.length?!1:{x:this._int(a),y:this._int(b),width:this._int(d),height:this._int(f)};return this._needAnimation=!0};b.prototype.setTransform=function(a){this.setSizes(a.sizes);this.setPosition(a.position);this.setCenter(a.center);this.setRotation(a.rotation);return this.setAlpha(a.alpha)};b.prototype.setSizes=function(a){null!=a&&(this._sizes=this._point(a));
this.canvas.width=this._sizes[0];this.canvas.height=this._sizes[1];return this._needAnimation=!0};b.prototype.setPosition=function(a){null!=a&&(this._position=this._point(a));this.canvas.style.left=this._position[0]+"px";this.canvas.style.top=this._position[1]+"px";return this._needAnimation=!0};b.prototype.setCenter=function(a){null!=a&&(this._center=this._point(a));this.context.translate(this._center[0],this._center[1]);return this._needAnimation=!0};b.prototype.setRotation=function(a){null!=a&&
(this._rotation=this._value(a));this.context.rotation=this._rotation*Math.PI/180;return this._needAnimation=!0};b.prototype.setAlpha=function(a){null!=a&&(this._alpha=this._value(a));this.context.globalAlpha=this._alpha;return this._needAnimation=!0};b.prototype.animate=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this._mask&&(this.context.beginPath(),this.context.rect(this._mask.x,this._mask.y,this._mask.width,this._mask.height),this.context.clip());this.objects.forEach(function(a){return function(a){return a.animate()}}(this));
return this._needAnimation=!1};return b}(f);var v=function(){function d(b){this._scenes=[];this._stage=b;this._activeSceneName=""}d.prototype.create=function(b){var a=b.name||"default";var c=this.get(a);c||(c=[this._stage.offsetLeft,this._stage.offsetTop],b.parentPosition=c,c=new u(b),this._stage.appendChild(c.canvas),this._scenes.push(c));if(null!=b.setActive?b.setActive:1)this._activeSceneName=a;return c};d.prototype.active=function(){return this._activeSceneName};d.prototype.active.set=function(b){var a;
if(a=this.get(b))this._activeSceneName=b;return a};d.prototype.active.get=function(){return this.get(this._activeSceneName)};d.prototype.get=function(b){var a=!1;this._scenes.some(function(c){var d;(d=c.name===b)&&(a=c);return d});return a};d.prototype.remove=function(b){b=this._index(b);return-1<b?(this._parent.removeChild(this._scenes[b].canvas),this._scenes.splice(b,1),!0):!1};d.prototype.rename=function(b,a){var c;if(c=this.get(b))c.name=a;return c};d.prototype.onTop=function(b){var a=0;var c=
!1;this._scenes.forEach(function(d){d.getZ()>a&&(a=d.getZ());if(b===d.name)return c=d});c&&c.setZ(a+1);return c};d.prototype.needAnimation=function(){return this._scenes.some(function(b){return b.needAnimation()})};d.prototype.animate=function(){return this._scenes.forEach(function(b){if(b.needAnimation())return b.animate()})};d.prototype._index=function(b){var a=-1;this._scenes.some(function(c){var d;(d=c.name===b)&&(a=c);return d});return a};return d}();var w=function(){function d(b){this._onTimer=
q(this._onTimer,this);this._scene=b.scene;this._graph=this._scene.add({type:"graph"});this._values=[];this._caption=this._scene.add({type:"text",fillStyle:"#00FF00",font:"10px Arial",position:[3,1]});this._caption2=this._scene.add({type:"text",fillStyle:"#FF0000",font:"10px Arial",position:[48,1]});this.start();this._onTimer()}d.prototype.start=function(){this._counter=this._updateCounter=this._FPSValue=0;return this._interval=setInterval(this._onTimer,1E3)};d.prototype.stop=function(){clearInterval(this._interval);
return this._counter=this._updateCounter=this._FPSValue=0};d.prototype._onTimer=function(){var b,a;this._FPSValue=this._counter;this._counter=0;this._updateValue=this._updateCounter;this._updateCounter=0;this._values.push([this._FPSValue,this._updateValue]);84===this._values.length&&this._values.shift();this._graph.clear();this._graph.fillStyle("#000");this._graph.rect(0,0,90,40);this._graph.fill();var c=b=0;for(a=this._values.length;0<=a?b<a:b>a;c=0<=a?++b:--b){var d=87-this._values.length+c;var f=
this._values[c][0];c=this._values[c][1];this._graph.strokeStyle("#00FF00");this._graph.line(d,37,d,37-23*f/60);this._graph.strokeStyle("#FF0000");this._graph.line(d,37,d,37-23*c/60)}this._caption.setText("FPS: "+this._FPSValue);return this._caption2.setText("UPS: "+this._updateValue)};d.prototype.update=function(b){this._counter++;if(b)return this._updateCounter++};return d}();return function(d){function b(a){this._animate=q(this._animate,this);if(!this._canvasSupport())return console.log("your browser not support canvas and/or context"),
!1;b.__super__.constructor.call(this,a);this._parent=a.parent||document.body;this.scenes=new v(this._parent);this._beforeAnimate=[];if(this._showFPS=null!=a.showFPS?a.showFPS:!0)a=this.scenes.create({name:"FPS",sizes:[90,40],position:[this._sizes[0]-95,5],zIndex:99999,setActive:!1}),this._FPS=new w({scene:a});this.start()}h(b,d);b.prototype.start=function(){return this._render=requestAnimationFrame(this._animate)};b.prototype.stop=function(){return cancelAnimationFrame(this._render)};b.prototype.addEvent=
function(a){return this._beforeAnimate.push(a)};b.prototype.removeEvent=function(a){return this._beforeAnimate.forEach(function(b){return function(c,d){if(c===a)return b._beforeAnimate.splice(d,1)}}(this))};b.prototype.add=function(a){if("scene"===(a.type||"scene"))return null==a.sizes&&(a.sizes=this._sizes),null==a.position&&(a.position=this._position),this.scenes.create(a);var b=a.scene||this.scenes.active()||"default";return this.scenes.create({name:b,sizes:this._sizes,position:this._position}).add(a)};
b.prototype._canvasSupport=function(){return null!=document.createElement("canvas").getContext};b.prototype._animate=function(){var a;this._beforeAnimate.forEach(function(a){if("function"===typeof a)return a()});(a=this.scenes.needAnimation())&&this.scenes.animate();this._showFPS&&this._FPS.update(a);return this._render=requestAnimationFrame(this._animate)};return b}(f)})}).call(this);